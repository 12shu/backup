#! /usr/bin/env ruby

##
# Load RubyGems for Ruby <= 1.8.7
require 'rubygems'

##
# Load Thor for the Command Line Interface
begin
  require 'thor'
rescue LoadError
  puts 'Backup uses Thor as CLI (Command Line Interface).'
  puts 'Please install Thor first: `gem install thor`'
end

##
# Load the Backup source
require File.expand_path("../../lib/backup", __FILE__)

##
# Build the Backup Command Line Interface using Thor
class BackupCLI < Thor

  ##
  # Aliases
  map '-v' => :version

  ##
  # Commands
  method_option :trigger, :type => :string, :aliases => '-t', :required => true
  method_option :config,  :type => :string, :aliases => '-c'
  desc 'perform', 'Performs the backup of the specified trigger'
  def perform
    Object.send(:const_set, :TRIGGER, options[:trigger])
    Object.send(:const_set, :TIME, Time.now.strftime("%Y.%m.%d.%H.%M.%S"))

    model = Backup::Finder.new(options[:trigger], options[:config]).find
    model.perform!
  end

  desc 'version', 'Display installed Backup version'
  def version
    puts "Backup #{Backup::Version.current}"
  end

end

##
# Enable the CLI for the Backup binary
BackupCLI.start